name: Vercel Preview Deployment & Alias

on:
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches-ignore:
      - main
      - preview
  workflow_dispatch:
    inputs:
      pr:
        description: 'PR number to alias (when running manually)'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: vercel-preview-${{ github.event_name }}-${{ github.ref || github.event.pull_request.head.sha }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Vercel Preview
    runs-on: ubuntu-latest
    # Avoid running with secrets on forked PRs
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Get PR information for workflow_dispatch
        id: get_pr_info
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          PR="${{ github.event.inputs.pr }}"
          if [ -z "$PR" ]; then
            echo "Manual run requires 'pr' input" >&2
            exit 1
          fi
          PR_JSON=$(curl -fsSL -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${{ github.repository }}/pulls/$PR")
          BRANCH=$(echo "$PR_JSON" | jq -r '.head.ref')
          SHA=$(echo "$PR_JSON" | jq -r '.head.sha')
          echo "pr=$PR" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
          # For workflow_dispatch, checkout the PR's head
          ref: ${{ steps.get_pr_info.outputs.sha || github.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Pull env (preview)
        run: vercel pull --yes --environment=preview --token ${{ secrets.VERCEL_TOKEN }}

      - name: Build
        run: vercel build --token ${{ secrets.VERCEL_TOKEN }}

      - name: Deploy (prebuilt)
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --token ${{ secrets.VERCEL_TOKEN }} | grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' | tail -n1)
          if [[ ! "$url" =~ ^https://[a-zA-Z0-9.-]+\.vercel\.app$ ]]; then
            echo "Failed to extract Vercel deployment URL" >&2
            exit 1
          fi
          echo "url=$url" >> $GITHUB_OUTPUT
          # Extract deployment ID for aliasing
          deploy_id=$(vercel ls --token ${{ secrets.VERCEL_TOKEN }} | grep $url | awk '{print $1}')
          echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT

      - name: Compute alias host (wildcard domain)
        id: alias
        if: ${{ vars.PREVIEW_ALIAS_DOMAIN != '' }}
        shell: bash
        run: |
          # Determine branch name based on event type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BRANCH="${{ steps.get_pr_info.outputs.branch }}"
            PR="${{ steps.get_pr_info.outputs.pr }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.event.pull_request.head.ref }}"
            PR="${{ github.event.pull_request.number }}"
          else
            BRANCH="${GITHUB_REF_NAME}"
            PR=""
          fi

          # slugify branch: lowercase, replace non-alnum with '-', collapse dashes, trim, limit length
          slug=$(echo "$BRANCH" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's#[^a-z0-9]+#-#g; s#-+#-#g; s#(^-|-$)##g' \
            | cut -c1-48)

          # If PR number is available, include it in the alias
          if [ -n "$PR" ]; then
            host="pr-$PR-$slug.${{ vars.PREVIEW_ALIAS_DOMAIN }}"
          else
            host="$slug.${{ vars.PREVIEW_ALIAS_DOMAIN }}"
          fi

          echo "Computed alias host: $host"
          echo "alias_host=$host" >> "$GITHUB_OUTPUT"

      - name: Create alias for deployment
        id: create_alias
        if: ${{ vars.PREVIEW_ALIAS_DOMAIN != '' && steps.alias.outputs.alias_host != '' && steps.deploy.outputs.deploy_id != '' }}
        continue-on-error: true
        run: |
          DEPLOY_ID="${{ steps.deploy.outputs.deploy_id }}"
          HOST="${{ steps.alias.outputs.alias_host }}"
          echo "Aliasing $DEPLOY_ID -> $HOST"
          vercel alias set "$DEPLOY_ID" "$HOST" --token "$VERCEL_TOKEN"
          echo "alias_url=https://$HOST" >> $GITHUB_OUTPUT

      - name: Verify wildcard alias resolves
        id: verify
        if: ${{ vars.PREVIEW_ALIAS_DOMAIN != '' && steps.create_alias.outputs.alias_url != '' }}
        shell: bash
        continue-on-error: true
        run: |
          host="${{ steps.alias.outputs.alias_host }}"
          if [ -z "$host" ]; then
            echo "Missing alias host" >&2
            exit 1
          fi
          echo "Probing wildcard alias: $host"
          attempts=40
          sleep_secs=15
          for i in $(seq 1 $attempts); do
            code=$(curl -sS -o /dev/null -w "%{http_code}" --max-time 10 "https://$host/")
            echo "Attempt $i/$attempts -> HTTP $code"
            if [ "$code" -ge 200 ] && [ "$code" -lt 500 ]; then
              echo "ok=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep $sleep_secs
          done
          echo "ok=false" >> "$GITHUB_OUTPUT"
          echo "Wildcard alias did not become ready within time window" >&2
          exit 1

      - name: Comment Preview URL on PR
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}
        uses: actions/github-script@v7
        with:
          script: |
            const url = `${{ steps.deploy.outputs.url }}`;
            if (!url) return;

            // Determine PR number based on event type
            let pr;
            if ('${{ github.event_name }}' === 'workflow_dispatch') {
              pr = '${{ steps.get_pr_info.outputs.pr }}';
            } else {
              pr = context.payload.pull_request.number;
            }

            const alias = `${{ steps.alias.outputs.alias_host }}`;
            const ok = `${{ steps.verify.outputs.ok }}`;

            let body = `## üöÄ Vercel Preview\n\n`;
            body += `- **Preview URL**: ${url}\n`;

            if (alias) {
              const aliasStatus = ok === 'true' ? '‚úÖ' : '‚è≥ (probing...)';
              body += `- **Alias URL**: https://${alias} ${aliasStatus}\n`;
            } else if ('${{ vars.PREVIEW_ALIAS_DOMAIN }}' === '') {
              body += `- **Alias URL**: (not configured - set PREVIEW_ALIAS_DOMAIN)\n`;
            }

            await github.rest.issues.createComment({ 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              issue_number: pr, 
              body 
            });
